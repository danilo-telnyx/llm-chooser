<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LLM Chooser ‚Äî Analytics Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0d1117;--bg2:#161b22;--bg3:#21262d;--border:#30363d;--text:#e6edf3;--text2:#8b949e;--accent:#58a6ff;--green:#3fb950;--red:#f85149;--purple:#bc8cff}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.login-container{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
.login-box{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:40px;max-width:400px;width:100%;text-align:center}
.login-box h1{font-size:1.5rem;margin-bottom:8px}
.login-box p{color:var(--text2);margin-bottom:24px;font-size:.9rem}
.login-box input{width:100%;padding:12px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:1rem;margin-bottom:12px;outline:none}
.login-box input:focus{border-color:var(--accent)}
.login-box button{width:100%;padding:12px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-size:1rem;cursor:pointer;font-weight:600}
.login-box button:hover{opacity:.9}
.login-box .error{color:var(--red);font-size:.85rem;margin-top:8px}
.dashboard{display:none;padding:24px;max-width:1400px;margin:0 auto}
.dashboard.active{display:block}
.login-container.hidden{display:none}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:12px}
header h1{font-size:1.6rem}
.period-btns button{padding:6px 14px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);border-radius:6px;cursor:pointer;font-size:.85rem;margin-left:4px}
.period-btns button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:20px}
.stat-card .label{color:var(--text2);font-size:.8rem;text-transform:uppercase;letter-spacing:.5px}
.stat-card .value{font-size:2rem;font-weight:700;margin-top:4px}
.charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:16px;margin-bottom:24px}
.chart-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:20px}
.chart-card h3{font-size:1rem;margin-bottom:12px;color:var(--text2)}
.table-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:20px;margin-bottom:24px;overflow-x:auto}
.table-card h3{font-size:1rem;margin-bottom:12px;color:var(--text2)}
table{width:100%;border-collapse:collapse}
th,td{padding:8px 12px;text-align:left;border-bottom:1px solid var(--border);font-size:.85rem}
th{color:var(--text2);font-weight:600}
td{color:var(--text)}
.logout-btn{padding:6px 14px;background:var(--red);color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:.85rem}
</style>
</head>
<body>

<div class="login-container" id="loginContainer">
  <div class="login-box">
    <h1>üîç Analytics Admin</h1>
    <p>LLM Chooser Dashboard</p>
    <div id="step1">
      <input type="password" id="password" placeholder="Admin password" autocomplete="current-password">
      <button onclick="login()">Sign In</button>
    </div>
    <div id="step2" style="display:none">
      <p style="color:var(--green);margin-bottom:16px">‚úÖ Check Telegram for your 2FA code</p>
      <input type="text" id="code2fa" placeholder="6-digit code" maxlength="6" autocomplete="one-time-code">
      <button onclick="verify2fa()">Verify</button>
    </div>
    <div class="error" id="loginError"></div>
  </div>
</div>

<div class="dashboard" id="dashboard">
  <header>
    <h1>üîç LLM Chooser Analytics</h1>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="period-btns">
        <button onclick="loadStats('today')" data-p="today">Today</button>
        <button onclick="loadStats('week')" data-p="week">Week</button>
        <button onclick="loadStats('month')" data-p="month" class="active">Month</button>
        <button onclick="loadStats('all')" data-p="all">All</button>
      </div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="stats-grid">
    <div class="stat-card"><div class="label">Total Pageviews</div><div class="value" id="totalViews">‚Äî</div></div>
    <div class="stat-card"><div class="label">Unique Visitors</div><div class="value" id="uniqueVisitors">‚Äî</div></div>
    <div class="stat-card"><div class="label">Top Browser</div><div class="value" id="topBrowser">‚Äî</div></div>
    <div class="stat-card"><div class="label">Top Country</div><div class="value" id="topCountry">‚Äî</div></div>
  </div>

  <div class="charts-grid">
    <div class="chart-card"><h3>üìà Pageviews (Last 30 Days)</h3><canvas id="dailyChart"></canvas></div>
    <div class="chart-card"><h3>üåê Browsers</h3><canvas id="browserChart"></canvas></div>
    <div class="chart-card"><h3>üì± Device Types</h3><canvas id="deviceChart"></canvas></div>
    <div class="chart-card"><h3>üîó Top Referrers</h3><canvas id="referrerChart"></canvas></div>
  </div>

  <div class="table-card">
    <h3>üïê Recent Visitors</h3>
    <table>
      <thead><tr><th>Time</th><th>Browser</th><th>Device</th><th>Country</th><th>Referrer</th><th>Language</th></tr></thead>
      <tbody id="recentTable"></tbody>
    </table>
  </div>
</div>

<script>
const API = location.origin;
let token = localStorage.getItem('analytics_token') || '';
let charts = {};

// Check existing token
if (token) {
  fetch(`${API}/api/stats?period=month`, { headers: { Authorization: `Bearer ${token}` } })
    .then(r => { if (r.ok) showDashboard(); else { token = ''; localStorage.removeItem('analytics_token'); } })
    .catch(() => {});
}

async function login() {
  const pw = document.getElementById('password').value;
  document.getElementById('loginError').textContent = '';
  try {
    const r = await fetch(`${API}/admin/auth`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pw })
    });
    const d = await r.json();
    if (!r.ok) { document.getElementById('loginError').textContent = d.error; return; }
    if (d.twoFactor) {
      document.getElementById('step1').style.display = 'none';
      document.getElementById('step2').style.display = 'block';
    } else {
      token = d.token;
      localStorage.setItem('analytics_token', token);
      showDashboard();
    }
  } catch (e) { document.getElementById('loginError').textContent = 'Connection error'; }
}

async function verify2fa() {
  const code = document.getElementById('code2fa').value;
  document.getElementById('loginError').textContent = '';
  try {
    const r = await fetch(`${API}/admin/verify-2fa`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code })
    });
    const d = await r.json();
    if (!r.ok) { document.getElementById('loginError').textContent = d.error; return; }
    token = d.token;
    localStorage.setItem('analytics_token', token);
    showDashboard();
  } catch (e) { document.getElementById('loginError').textContent = 'Connection error'; }
}

function logout() {
  token = '';
  localStorage.removeItem('analytics_token');
  location.reload();
}

function showDashboard() {
  document.getElementById('loginContainer').classList.add('hidden');
  document.getElementById('dashboard').classList.add('active');
  loadStats('month');
}

async function loadStats(period) {
  document.querySelectorAll('.period-btns button').forEach(b => b.classList.toggle('active', b.dataset.p === period));
  try {
    const r = await fetch(`${API}/api/stats?period=${period}`, { headers: { Authorization: `Bearer ${token}` } });
    if (!r.ok) { if (r.status === 401) logout(); return; }
    const d = await r.json();
    render(d);
  } catch (e) { console.error(e); }
}

function render(d) {
  document.getElementById('totalViews').textContent = d.total.toLocaleString();
  document.getElementById('uniqueVisitors').textContent = d.unique.toLocaleString();
  document.getElementById('topBrowser').textContent = d.browsers[0]?.browser || '‚Äî';
  document.getElementById('topCountry').textContent = d.countries[0]?.country || '‚Äî';

  // Daily chart
  renderChart('dailyChart', 'line', {
    labels: d.daily.map(x => x.day.slice(5)),
    datasets: [{ label: 'Pageviews', data: d.daily.map(x => x.count), borderColor: '#58a6ff', backgroundColor: 'rgba(88,166,255,.1)', fill: true, tension: .3 }]
  });

  // Browser chart
  renderChart('browserChart', 'doughnut', {
    labels: d.browsers.map(x => x.browser),
    datasets: [{ data: d.browsers.map(x => x.count), backgroundColor: ['#58a6ff','#3fb950','#d29922','#f85149','#bc8cff','#8b949e'] }]
  });

  // Device chart
  renderChart('deviceChart', 'doughnut', {
    labels: d.devices.map(x => x.device_type),
    datasets: [{ data: d.devices.map(x => x.count), backgroundColor: ['#58a6ff','#3fb950','#d29922'] }]
  });

  // Referrer chart
  renderChart('referrerChart', 'bar', {
    labels: d.referrers.map(x => { try { return new URL(x.referrer).hostname; } catch { return x.referrer.slice(0,30); } }),
    datasets: [{ label: 'Visits', data: d.referrers.map(x => x.count), backgroundColor: '#bc8cff' }]
  }, { indexAxis: 'y' });

  // Recent table
  const tbody = document.getElementById('recentTable');
  tbody.innerHTML = d.recent.map(r => `<tr>
    <td>${new Date(r.timestamp+'Z').toLocaleString()}</td>
    <td>${r.browser}</td><td>${r.device_type}</td>
    <td>${r.country||'‚Äî'}</td><td>${r.referrer?`<a href="${r.referrer}" style="color:var(--accent)">${r.referrer.slice(0,40)}</a>`:'Direct'}</td>
    <td>${r.language||'‚Äî'}</td>
  </tr>`).join('');
}

function renderChart(id, type, data, extra = {}) {
  if (charts[id]) charts[id].destroy();
  const ctx = document.getElementById(id).getContext('2d');
  charts[id] = new Chart(ctx, {
    type, data,
    options: {
      responsive: true, plugins: { legend: { labels: { color: '#8b949e' } } },
      scales: type === 'doughnut' ? {} : {
        x: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
        y: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } }
      },
      ...extra
    }
  });
}
</script>
</body>
</html>
